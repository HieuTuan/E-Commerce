<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details - E-Commerce</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/customer.css}">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" th:href="@{/}"><i class="fas fa-shopping-bag"></i> E-Commerce</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" th:href="@{/}">Home</a>
                <a class="nav-link" th:href="@{/products}">Products</a>
                <a class="nav-link" th:href="@{/cart}"><i class="fas fa-shopping-cart"></i> Cart</a>
                <a class="nav-link active" th:href="@{/orders}">My Orders</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <!-- Success/Error Messages -->
        <div th:if="${param.confirmed}" class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i>
            <strong>Th√†nh c√¥ng!</strong> B·∫°n ƒë√£ x√°c nh·∫≠n nh·∫≠n h√†ng th√†nh c√¥ng. C·∫£m ∆°n b·∫°n!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${param.rejected}" class="alert alert-warning alert-dismissible fade show">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>ƒê√£ b√°o c√°o!</strong> Ch√∫ng t√¥i ƒë√£ nh·∫≠n ƒë∆∞·ª£c b√°o c√°o c·ªßa b·∫°n v√† s·∫Ω x·ª≠ l√Ω s·ªõm nh·∫•t.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-times-circle me-2"></i>
            <strong>L·ªói!</strong>
            <span th:if="${param.error[0] == 'invalid_confirmation'}">Kh√¥ng th·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng n√†y.</span>
            <span th:if="${param.error[0] == 'invalid_rejection'}">Kh√¥ng th·ªÉ b√°o c√°o v·∫•n ƒë·ªÅ cho ƒë∆°n h√†ng n√†y.</span>
            <span th:if="${param.error[0] == 'confirmation_failed'}">C√≥ l·ªói x·∫£y ra khi x√°c nh·∫≠n. Vui l√≤ng th·ª≠
                l·∫°i.</span>
            <span th:if="${param.error[0] == 'rejection_failed'}">C√≥ l·ªói x·∫£y ra khi b√°o c√°o. Vui l√≤ng th·ª≠ l·∫°i.</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Order #<span th:text="${order.orderNumber}">ORD-001</span></h4>
                <small th:text="${#temporals.format(order.createdDate, 'dd/MM/yyyy HH:mm')}">Date</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Order Status</h6>
                        <!-- Show red status with "Kh√°ch h√†ng report" when has delivery issue -->
                        <div th:if="${order.hasDeliveryIssue()}">
                            <span class="badge bg-danger">DELIVERED</span>
                            <small class="text-danger d-block mt-1">
                                <i class="fas fa-exclamation-triangle me-1"></i>Kh√°ch h√†ng report
                            </small>
                        </div>
                        <!-- Normal status display -->
                        <div th:unless="${order.hasDeliveryIssue()}">
                            <span class="badge bg-warning" th:text="${order.status}">Status</span>
                            <!-- Show return status if order has active return request -->
                            <div th:if="${order.hasActiveReturnRequest()}">
                                <small class="text-warning d-block mt-1">
                                    <i class="fas fa-undo me-1"></i>ƒêang ho√†n h√†ng
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Payment Status</h6>
                        <span class="badge bg-info" th:text="${order.paymentStatus}">Payment</span>
                    </div>
                    <div class="col-md-4">
                        <h6>Total Amount</h6>
                        <h5 class="text-primary"><span
                                th:text="${#numbers.formatInteger(order.totalAmount, 3, 'POINT')}"></span>ƒë</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Order Items</h5>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item : ${order.items}">
                                    <td th:text="${item.product.name}">Product</td>
                                    <td><span th:text="${#numbers.formatInteger(item.price, 3, 'POINT')}"></span>ƒë</td>
                                    <td th:text="${item.quantity}">1</td>
                                    <td><span
                                            th:text="${#numbers.formatInteger(item.price * item.quantity, 3, 'POINT')}"></span>ƒë
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Order Timeline Section -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Order Timeline</h5>
                        <a th:href="@{/orders/{id}/timeline(id=${order.id})}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-expand-arrows-alt me-1"></i>View Full Timeline
                        </a>
                    </div>
                    <div class="card-body">
                        <!-- Timeline -->
                        <div th:if="${timeline != null and !timeline.empty}" class="timeline-container">
                            <style>
                                .timeline-container {
                                    position: relative;
                                    padding: 20px 0;
                                }

                                .timeline-container::before {
                                    content: '';
                                    position: absolute;
                                    left: 20px;
                                    top: 0;
                                    bottom: 0;
                                    width: 2px;
                                    background: #dee2e6;
                                }

                                .timeline-item {
                                    position: relative;
                                    margin-bottom: 20px;
                                    padding-left: 60px;
                                }

                                .timeline-icon {
                                    position: absolute;
                                    left: 8px;
                                    top: 0;
                                    width: 24px;
                                    height: 24px;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-size: 12px;
                                    z-index: 1;
                                }

                                .timeline-icon.pending {
                                    background: #6c757d;
                                }

                                .timeline-icon.pending::after {
                                    content: '‚è±Ô∏è';
                                    font-size: 14px;
                                }

                                .timeline-icon.confirmed {
                                    background: #0d6efd;
                                }

                                .timeline-icon.confirmed::after {
                                    content: '‚úÖ';
                                    font-size: 14px;
                                }

                                .timeline-icon.shipping {
                                    background: #fd7e14;
                                }

                                .timeline-icon.shipping::after {
                                    content: 'üöö';
                                    font-size: 14px;
                                }

                                .timeline-icon.delivered {
                                    background: #198754;
                                }

                                .timeline-icon.delivered::after {
                                    content: 'üì¶';
                                    font-size: 14px;
                                }

                                .timeline-icon.cancelled {
                                    background: #dc3545;
                                }

                                .timeline-icon.cancelled::after {
                                    content: '‚ùå';
                                    font-size: 14px;
                                }

                                .timeline-icon.confirmed_by_customer {
                                    background: #20c997;
                                }

                                .timeline-icon.confirmed_by_customer::after {
                                    content: '‚úÖ';
                                    font-size: 14px;
                                }

                                .timeline-content {
                                    background: #f8f9fa;
                                    border: 1px solid #dee2e6;
                                    border-radius: 6px;
                                    padding: 15px;
                                }

                                .timeline-status {
                                    font-weight: bold;
                                    margin-bottom: 5px;
                                }

                                .timeline-time {
                                    color: #6c757d;
                                    font-size: 0.9em;
                                }

                                .timeline-user {
                                    color: #495057;
                                    font-size: 0.9em;
                                    margin-top: 5px;
                                }

                                .timeline-notes {
                                    margin-top: 8px;
                                    padding: 8px;
                                    background: white;
                                    border-radius: 4px;
                                    font-style: italic;
                                    border-left: 3px solid #0d6efd;
                                }
                            </style>

                            <div class="timeline-item" th:each="entry : ${timeline}">
                                <div class="timeline-icon" th:classappend="${entry.status.name().toLowerCase()}">
                                </div>

                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="timeline-status" th:text="${entry.status.displayName}"></div>
                                        <div class="timeline-time"
                                            th:text="${#temporals.format(entry.updatedAt, 'dd/MM/yyyy HH:mm')}"></div>
                                    </div>

                                    <div class="timeline-user" th:if="${entry.updatedBy}">
                                        <i class="fas fa-user me-1"></i>
                                        Updated by: <span th:text="${entry.updatedBy}"></span>
                                    </div>

                                    <div class="timeline-notes" th:if="${entry.notes}">
                                        <i class="fas fa-sticky-note me-1"></i>
                                        <span th:text="${entry.notes}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div th:if="${timeline == null or timeline.empty}" class="text-center py-4">
                            <i class="fas fa-clock fa-2x text-muted mb-3"></i>
                            <h6 class="text-muted">No timeline information available</h6>
                            <p class="text-muted small">Timeline will be updated when order status changes.</p>
                        </div>

                        <!-- Customer Delivery Confirmation - Show for DELIVERED and all return-related statuses -->
                        <div th:if="${order.currentStatus.name() == 'DELIVERED' or 
                                      order.currentStatus.name() == 'REFUND_REQUESTED' or 
                                      order.currentStatus.name() == 'RETURN_APPROVED' or 
                                      order.currentStatus.name() == 'RETURNING' or 
                                      order.currentStatus.name() == 'RETURN_RECEIVED'}" class="mt-4">
                            <div class="alert alert-success">
                                <i class="fas fa-truck me-2"></i>
                                <strong>ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c giao</strong><br>
                                ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c giao ƒë·∫øn ƒë·ªãa ch·ªâ c·ªßa b·∫°n. Vui l√≤ng x√°c nh·∫≠n vi·ªác nh·∫≠n h√†ng ho·∫∑c b√°o c√°o
                                n·∫øu c√≥ v·∫•n ƒë·ªÅ.
                                <br><small class="text-muted">Vi·ªác x√°c nh·∫≠n gi√∫p ch√∫ng t√¥i ho√†n t·∫•t ƒë∆°n h√†ng v√† c·∫£i
                                    thi·ªán d·ªãch v·ª•.</small>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <form th:action="@{/orders/{orderId}/confirm-delivery(orderId=${order.id})}"
                                        method="post" class="d-inline">
                                        <button type="submit" class="btn btn-success w-100">
                                            <i class="fas fa-check me-2"></i>X√°c nh·∫≠n ƒë√£ nh·∫≠n h√†ng
                                        </button>
                                    </form>
                                </div>

                                <div class="col-md-4" th:if="${order.returnRequest == null}">
                                    <a th:href="@{/returns/orders/{orderId}/request(orderId=${order.id})}"
                                        class="btn btn-warning w-100">
                                        <i class="fas fa-undo me-2"></i>Y√™u c·∫ßu ho√†n ti·ªÅn
                                    </a>
                                </div>
                                <div class="col-md-4" th:if="${order.returnRequest != null}">
                                    <a th:href="@{/customer/returns/{id}(id=${order.returnRequest.id})}"
                                        class="btn btn-info w-100">
                                        <i class="fas fa-eye me-2"></i>Xem chi ti·∫øt ƒë∆°n ho√†n
                                    </a>
                                </div>
                                <div class="col-md-4">
                                    <!-- Check if order has delivery issue report -->
                                    <div th:if="${order.hasDeliveryIssue()}">
                                        <button type="button" class="btn btn-secondary w-100" disabled>
                                            <i class="fas fa-check me-2"></i>ƒê√£ b√°o c√°o v·∫•n ƒë·ªÅ
                                        </button>
                                    </div>
                                    <div th:unless="${order.hasDeliveryIssue()}">
                                        <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal"
                                            data-bs-target="#deliveryIssueModal"
                                            th:attr="data-order-id=${order.id}, data-order-number=${order.orderNumber}">
                                            <i class="fas fa-exclamation-triangle me-2"></i>B√°o c√°o v·∫•n ƒë·ªÅ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Delivery Issue Reports Section -->
                        <div th:if="${order.hasDeliveryIssue()}" class="mt-4">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        B√°o c√°o v·∫•n ƒë·ªÅ giao h√†ng
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div th:each="report : ${order.deliveryIssues}" class="mb-3">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <p class="mb-1">
                                                    <strong>L√Ω do:</strong> <span th:text="${report.issueType}">Issue
                                                        Type</span>
                                                </p>
                                                <p class="mb-1" th:if="${report.description}">
                                                    <strong>M√¥ t·∫£:</strong> <span
                                                        th:text="${report.description}">Description</span>
                                                </p>
                                                <small class="text-muted">
                                                    B√°o c√°o l√∫c: <span
                                                        th:text="${#temporals.format(report.reportedAt, 'dd/MM/yyyy HH:mm')}">Date</span>
                                                </small>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <!-- Status display based on report status -->
                                                <div th:if="${report.status.name() == 'PENDING'}">
                                                    <span class="badge bg-warning">ƒêang x·ª≠ l√Ω</span>
                                                    <small class="text-muted d-block mt-1">Ch√∫ng t√¥i s·∫Ω li√™n h·ªá s·ªõm
                                                        nh·∫•t</small>
                                                </div>
                                                <div th:if="${report.status.name() == 'RESOLVED'}">
                                                    <span class="badge bg-success">ƒê√£ gi·∫£i quy·∫øt</span>
                                                    <small class="text-success d-block mt-1">V·∫•n ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c x·ª≠
                                                        l√Ω</small>
                                                    <div th:if="${report.adminNotes}" class="mt-2">
                                                        <small class="text-muted">
                                                            <strong>Ghi ch√∫:</strong> <span
                                                                th:text="${report.adminNotes}">Notes</span>
                                                        </small>
                                                    </div>
                                                </div>
                                                <div th:if="${report.status.name() == 'REJECTED'}">
                                                    <span class="badge bg-danger">ƒê√£ t·ª´ ch·ªëi</span>
                                                    <small class="text-danger d-block mt-1">Vui l√≤ng li√™n h·ªá hotline ƒë·ªÉ
                                                        bi·∫øt th√™m chi ti·∫øt</small>
                                                    <div th:if="${report.adminNotes}" class="mt-2">
                                                        <small class="text-muted">
                                                            <strong>L√Ω do:</strong> <span
                                                                th:text="${report.adminNotes}">Reason</span>
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <hr th:unless="${reportStat.last}">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Completed - After Customer Confirmation -->
                        <div th:if="${order.currentStatus.name() == 'CONFIRMED_BY_CUSTOMER'}" class="mt-4">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>ƒê∆°n h√†ng ƒë√£ ho√†n th√†nh</strong><br>
                                C·∫£m ∆°n b·∫°n ƒë√£ x√°c nh·∫≠n nh·∫≠n h√†ng. ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ho√†n t·∫•t th√†nh c√¥ng.
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-success w-100" disabled>
                                        <i class="fas fa-check me-2"></i>ƒê√£ x√°c nh·∫≠n h√†ng
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-secondary w-100" disabled>
                                        <i class="fas fa-undo me-2"></i>Y√™u c·∫ßu ho√†n ti·ªÅn
                                    </button>
                                    <small class="text-muted d-block mt-1">Kh√¥ng kh·∫£ d·ª•ng sau khi x√°c nh·∫≠n</small>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-secondary w-100" disabled>
                                        <i class="fas fa-exclamation-triangle me-2"></i>B√°o c√°o v·∫•n ƒë·ªÅ
                                    </button>
                                    <small class="text-muted d-block mt-1">Kh√¥ng kh·∫£ d·ª•ng sau khi x√°c nh·∫≠n</small>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Shipping Information</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Name:</strong><br><span th:text="${order.customerName}">Name</span></p>
                        <p><strong>Address:</strong><br><span th:text="${order.decodedShippingAddress}">Address</span>
                        </p>
                        <p><strong>Phone:</strong><br><span th:text="${order.customerPhone}">Phone</span></p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Payment Information</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Method:</strong><br><span th:text="${order.paymentMethod}">COD</span></p>
                        <p><strong>Status:</strong><br><span class="badge bg-success"
                                th:text="${order.paymentStatus}">Status</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <a th:href="@{/orders}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to My Orders
            </a>
        </div>
    </div>

    <footer class="bg-dark text-white mt-5 py-4">
        <div class="container text-center">
            <p>&copy; 2026 E-Commerce Platform. All rights reserved.</p>
        </div>
    </footer>

    <!-- Reject Delivery Modal -->
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectModalLabel">B√°o c√°o v·∫•n ƒë·ªÅ giao h√†ng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{/orders/{orderId}/reject-delivery(orderId=${order.id})}" method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="reason" class="form-label">L√Ω do t·ª´ ch·ªëi nh·∫≠n h√†ng:</label>
                            <select class="form-select" id="reason" name="reason" required>
                                <option value="">Ch·ªçn l√Ω do...</option>
                                <option value="H√†ng b·ªã h·ªèng">H√†ng b·ªã h·ªèng</option>
                                <option value="Kh√¥ng ƒë√∫ng s·∫£n ph·∫©m">Kh√¥ng ƒë√∫ng s·∫£n ph·∫©m</option>
                                <option value="Thi·∫øu h√†ng">Thi·∫øu h√†ng</option>
                                <option value="Giao mu·ªôn">Giao mu·ªôn</option>
                                <option value="Kh√°c">Kh√°c</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="customReason" class="form-label">Chi ti·∫øt (t√πy ch·ªçn):</label>
                            <textarea class="form-control" id="customReason" name="customReason" rows="3"
                                placeholder="M√¥ t·∫£ chi ti·∫øt v·∫•n ƒë·ªÅ..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="submit" class="btn btn-danger">B√°o c√°o v·∫•n ƒë·ªÅ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Include Delivery Issue Modal -->
    <div th:replace="fragments/delivery-issue-modal :: delivery-issue-modal"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Include Delivery Issue Script -->
    <div th:replace="fragments/delivery-issue-modal :: delivery-issue-script"></div>
</body>

</html>