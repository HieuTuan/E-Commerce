<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - E-Commerce</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/customer.css}">
    <link rel="stylesheet" th:href="@{/css/password-toggle.css}">
</head>

<body class="bg-light">
    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow">
                    <div class="card-body p-5">
                        <h3 class="text-center mb-4">
                            <i class="fas fa-user-plus text-primary"></i> Register
                        </h3>

                        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

                        <form th:action="@{/register}" th:object="${user}" method="post" autocomplete="on">
                            <!-- Personal Information -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fullName" class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" id="fullName" th:field="*{fullName}" 
                                           autocomplete="name" required maxlength="100" placeholder="Enter your full name">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="birthDate" class="form-label">Date of Birth *</label>
                                    <input type="date" class="form-control" id="birthDate" name="birthDate" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">Phone Number *</label>
                                    <input type="tel" class="form-control" id="phone" th:field="*{phone}"
                                           autocomplete="tel" required placeholder="Enter phone number" maxlength="10">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="email" th:field="*{email}"
                                           autocomplete="email" required placeholder="Enter email address">
                                </div>
                            </div>
                            
                            <!-- Password Section -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="password" class="form-label">Password *</label>
                                    <div class="position-relative">
                                        <input type="password" class="form-control" id="password" th:field="*{password}"
                                               autocomplete="new-password" required minlength="6" placeholder="Enter password"
                                               style="padding-right: 45px;">
                                        <button type="button" class="btn position-absolute" 
                                                style="right: 5px; top: 50%; transform: translateY(-50%); border: none; background: none; z-index: 10; padding: 5px 10px;"
                                                onclick="togglePassword('password')">
                                            <i class="fas fa-eye text-muted" id="password-icon"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="confirmPassword" class="form-label">Confirm Password *</label>
                                    <div class="position-relative">
                                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                                               autocomplete="new-password" required minlength="6" placeholder="Confirm password"
                                               style="padding-right: 45px;">
                                        <button type="button" class="btn position-absolute" 
                                                style="right: 5px; top: 50%; transform: translateY(-50%); border: none; background: none; z-index: 10; padding: 5px 10px;"
                                                onclick="togglePassword('confirmPassword')">
                                            <i class="fas fa-eye text-muted" id="confirmPassword-icon"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="address" class="form-label">Address</label>
                                <textarea class="form-control" id="address" th:field="*{address}" 
                                          autocomplete="street-address" rows="2" placeholder="Enter address (optional)"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100 mb-3">
                                <i class="fas fa-user-plus"></i> Register
                            </button>
                        </form>

                        <div class="text-center">
                            <p>Already have an account? <a th:href="@{/login}">Login here</a></p>
                            <a th:href="@{/}" class="text-muted">Back to Home</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/password-toggle.js}"></script>
    <script>
        // Password toggle function
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + '-icon');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');

            // Validation functions
            function validateFullName(value) {
                if (!value || !value.trim()) {
                    return 'Full name is required';
                }
                if (value.length > 100) {
                    return 'Full name must not exceed 100 characters';
                }
                // Check if first letter of each word is uppercase
                const words = value.trim().split(/\s+/);
                for (let word of words) {
                    if (word.length > 0 && !/^[A-Z]/.test(word)) {
                        return 'Each word in full name must start with an uppercase letter';
                    }
                }
                return null;
            }

            function validateBirthDate(value) {
                if (!value) {
                    return 'Date of birth is required';
                }
                
                const birthDate = new Date(value);
                const today = new Date();
                
                if (birthDate > today) {
                    return 'Date of birth cannot be in the future';
                }
                
                const age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (age < 15 || (age === 15 && monthDiff < 0) || 
                   (age === 15 && monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    return 'You must be at least 15 years old';
                }
                return null;
            }

            function validatePhone(value) {
                if (!value || !value.trim()) {
                    return 'Phone number is required';
                }
                const cleanValue = value.replace(/\s+/g, '');
                if (!/^(03|05|07|08|09)[0-9]{8}$/.test(cleanValue)) {
                    return 'Phone number must be 10 digits starting with 03, 05, 07, 08, or 09';
                }
                return null;
            }

            function validateEmail(value) {
                if (!value || !value.trim()) {
                    return 'Email is required';
                }
                const emailPattern = /^[a-zA-Z0-9_+&*-]+(?:\.[a-zA-Z0-9_+&*-]+)*@(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,7}$/;
                if (!emailPattern.test(value.trim())) {
                    return 'Please enter a valid email address';
                }
                return null;
            }

            function validatePassword(value) {
                if (!value) {
                    return 'Password is required';
                }
                if (value.length < 6) {
                    return 'Password must be at least 6 characters';
                }
                if (!/(?=.*[a-z])/.test(value)) {
                    return 'Password must contain at least one lowercase letter';
                }
                if (!/(?=.*[A-Z])/.test(value)) {
                    return 'Password must contain at least one uppercase letter';
                }
                if (!/(?=.*\d)/.test(value)) {
                    return 'Password must contain at least one number';
                }
                if (!/(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?])/.test(value)) {
                    return 'Password must contain at least one special character';
                }
                return null;
            }

            function validatePasswordMatch(password, confirmPassword) {
                if (confirmPassword && password !== confirmPassword) {
                    return 'Passwords do not match';
                }
                return null;
            }

            function showFieldError(fieldId, message) {
                const field = document.getElementById(fieldId);
                field.classList.add('is-invalid');
                
                // Remove existing error message
                const existingError = field.parentNode.querySelector('.invalid-feedback');
                if (existingError) {
                    existingError.remove();
                }
                
                // Add new error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback';
                errorDiv.textContent = message;
                field.parentNode.appendChild(errorDiv);
            }

            function clearFieldError(fieldId) {
                const field = document.getElementById(fieldId);
                field.classList.remove('is-invalid');
                
                const existingError = field.parentNode.querySelector('.invalid-feedback');
                if (existingError) {
                    existingError.remove();
                }
            }

            // Form submission validation
            form.addEventListener('submit', function(e) {
                let isValid = true;
                
                // Clear all previous errors
                ['fullName', 'birthDate', 'phone', 'email', 'password', 'confirmPassword'].forEach(fieldId => {
                    clearFieldError(fieldId);
                });

                // Validate all fields
                const fullNameError = validateFullName(document.getElementById('fullName').value);
                if (fullNameError) {
                    showFieldError('fullName', fullNameError);
                    isValid = false;
                }

                const birthDateError = validateBirthDate(document.getElementById('birthDate').value);
                if (birthDateError) {
                    showFieldError('birthDate', birthDateError);
                    isValid = false;
                }

                const phoneError = validatePhone(document.getElementById('phone').value);
                if (phoneError) {
                    showFieldError('phone', phoneError);
                    isValid = false;
                }

                const emailError = validateEmail(document.getElementById('email').value);
                if (emailError) {
                    showFieldError('email', emailError);
                    isValid = false;
                }

                const passwordError = validatePassword(document.getElementById('password').value);
                if (passwordError) {
                    showFieldError('password', passwordError);
                    isValid = false;
                }

                const passwordMatchError = validatePasswordMatch(
                    document.getElementById('password').value,
                    document.getElementById('confirmPassword').value
                );
                if (passwordMatchError) {
                    showFieldError('confirmPassword', passwordMatchError);
                    isValid = false;
                }

                if (!isValid) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Scroll to first error
                    const firstError = document.querySelector('.is-invalid');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstError.focus();
                    }
                }
            });
        });
    </script>
</body>

</html>