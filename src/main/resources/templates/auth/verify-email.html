<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Email - E-Commerce</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .verify-container {
            max-width: 400px;
            margin: 3rem auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        
        .verify-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .verify-header h3 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .email-display {
            color: #0d6efd;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .otp-input {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5rem;
            padding: 1rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }
        
        .otp-input:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .timer-display {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            margin: 1rem 0;
            color: #856404;
        }
        
        .timer-number {
            font-weight: 700;
            font-size: 1.1rem;
            color: #dc3545;
        }
        
        .resend-section {
            text-align: center;
            margin-top: 1.5rem;
        }
        
        .btn-resend {
            background: none;
            border: 1px solid #6c757d;
            color: #6c757d;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .btn-resend:hover:not(:disabled) {
            background: #6c757d;
            color: white;
        }
        
        .btn-resend:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .alert-custom {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .alert-success {
            background: #d1edff;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>

<body>
    <div class="verify-container">
        <div class="verify-header">
            <h3><i class="fas fa-envelope text-primary"></i> Verify Email</h3>
            <p class="text-muted mb-2">Code sent to</p>
            <div class="email-display" th:text="${email}">us***@example.com</div>
        </div>

        <!-- Alert Messages -->
        <div th:if="${error}" class="alert-custom alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${error}"></span>
        </div>
        
        <div id="success-message" class="alert-custom alert-success" style="display: none;">
            <i class="fas fa-check-circle me-2"></i>
            <span>Code sent successfully!</span>
        </div>

        <!-- Timer Display -->
        <div class="timer-display" id="timer-display">
            <i class="fas fa-clock me-2"></i>
            Code expires in <span class="timer-number" id="countdown" th:text="${remainingSeconds ?: 60}">60</span> seconds
        </div>

        <form th:action="@{/verify-email}" method="post" id="verify-form">
            <div class="mb-3">
                <label for="otp" class="form-label">Verification Code</label>
                <input type="text" class="form-control otp-input" id="otp" name="otp" 
                       maxlength="6" pattern="[0-9]{6}" required autofocus
                       placeholder="000000" autocomplete="one-time-code"
                       th:disabled="${isBlocked}">
                <div class="form-text text-center">
                    Enter the 6-digit code sent to your email
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary w-100 mb-3" th:disabled="${isBlocked}">
                <i class="fas fa-check me-2"></i>Verify Email Address
            </button>
        </form>

        <!-- Resend Section - Only show when not blocked -->
        <div class="resend-section" th:unless="${isBlocked}">
            <p class="text-muted mb-2">Didn't receive the code?</p>
            <button type="button" class="btn btn-resend" id="resend-btn" disabled>
                <i class="fas fa-redo me-2"></i>Resend Code (Wait for expiry)
            </button>
        </div>

        <!-- Blocked Message -->
        <div class="text-center mt-3" th:if="${isBlocked}">
            <div class="alert-custom alert-danger">
                <i class="fas fa-clock me-2"></i>
                <span>Please wait 5 minutes before trying again with this email.</span>
            </div>
        </div>

        <div class="text-center mt-3">
            <a th:href="@{/register}" class="text-muted text-decoration-none">
                <i class="fas fa-arrow-left me-1"></i>Back to Registration
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get initial countdown time from server-rendered value
            let countdownTime = parseInt(document.getElementById('countdown').textContent) || 60;
            let otpExpired = countdownTime <= 0;
            let mainTimer;
            
            const countdownElement = document.getElementById('countdown');
            const resendBtn = document.getElementById('resend-btn');
            const timerDisplay = document.getElementById('timer-display');
            const successMessage = document.getElementById('success-message');
            
            function startMainTimer() {
                if (mainTimer) clearInterval(mainTimer);
                
                if (countdownTime <= 0) {
                    otpExpired = true;
                    timerDisplay.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><span style="color: #dc3545;">Code has expired</span>';
                    document.getElementById('otp').disabled = true;
                    document.querySelector('button[type="submit"]').disabled = true;
                    resendBtn.disabled = false;
                    resendBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend Code';
                    return;
                }
                
                mainTimer = setInterval(function() {
                    countdownTime--;
                    const currentCountdownElement = document.getElementById('countdown');
                    if (currentCountdownElement) {
                        currentCountdownElement.textContent = countdownTime;
                    }
                    
                    if (countdownTime <= 0) {
                        clearInterval(mainTimer);
                        otpExpired = true;
                        timerDisplay.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><span style="color: #dc3545;">Code has expired</span>';
                        document.getElementById('otp').disabled = true;
                        document.querySelector('button[type="submit"]').disabled = true;
                        
                        // Enable resend button when OTP expires
                        resendBtn.disabled = false;
                        resendBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend Code';
                    }
                }, 1000);
            }
            
            // Check if form is blocked initially
            const isBlocked = document.getElementById('otp').disabled;
            if (isBlocked) {
                // If blocked, show blocked message and hide resend section
                timerDisplay.innerHTML = '<i class="fas fa-ban me-2"></i><span style="color: #dc3545;">Too many failed attempts. Please wait 5 minutes.</span>';
                return; // Don't set up timers or resend functionality
            } else if (otpExpired) {
                timerDisplay.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><span style="color: #dc3545;">Code has expired</span>';
                document.getElementById('otp').disabled = true;
                document.querySelector('button[type="submit"]').disabled = true;
                resendBtn.disabled = false;
                resendBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend Code';
            } else {
                startMainTimer();
                // Initially disable resend button until OTP expires
                resendBtn.disabled = true;
                resendBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend Code (Wait for expiry)';
            }
            
            // Resend button click (only if resend button exists)
            if (resendBtn) {
                resendBtn.addEventListener('click', function() {
                if (resendBtn.disabled) return;
                
                // Allow resend if blocked OR expired
                if (!isBlocked && !otpExpired) return;
                
                // Disable button during request
                resendBtn.disabled = true;
                resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
                
                fetch('/api/resend-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message in English
                        successMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i><span>New verification code sent successfully!</span>';
                        successMessage.style.display = 'block';
                        setTimeout(() => {
                            successMessage.style.display = 'none';
                        }, 3000);
                        
                        // Reset everything for new OTP
                        countdownTime = 60;
                        otpExpired = false;
                        
                        // Re-enable form (unblock)
                        document.getElementById('otp').disabled = false;
                        document.querySelector('button[type="submit"]').disabled = false;
                        document.getElementById('otp').value = '';
                        document.getElementById('otp').focus();
                        
                        // Update timer display
                        const newCountdownElement = document.createElement('span');
                        newCountdownElement.className = 'timer-number';
                        newCountdownElement.id = 'countdown';
                        newCountdownElement.textContent = '60';
                        timerDisplay.innerHTML = '<i class="fas fa-clock me-2"></i>Code expires in ';
                        timerDisplay.appendChild(newCountdownElement);
                        timerDisplay.appendChild(document.createTextNode(' seconds'));
                        
                        // Disable resend button again until new OTP expires
                        resendBtn.disabled = true;
                        resendBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend Code (Wait for expiry)';
                        
                        // Restart timer
                        startMainTimer();
                    } else {
                        alert('Failed to resend code: ' + data.message);
                        // Re-enable resend button on failure
                        resendBtn.disabled = false;
                        resendBtn.innerHTML = isBlocked ? '<i class="fas fa-redo me-2"></i>Get New Code' : '<i class="fas fa-redo me-2"></i>Resend Code';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to resend code. Please try again.');
                    // Re-enable resend button on error
                    resendBtn.disabled = false;
                    resendBtn.innerHTML = isBlocked ? '<i class="fas fa-redo me-2"></i>Get New Code' : '<i class="fas fa-redo me-2"></i>Resend Code';
                });
            }
            
            // Auto-submit when 6 digits entered
            document.getElementById('otp').addEventListener('input', function() {
                if (this.value.length === 6 && !otpExpired) {
                    // Small delay to let user see the complete code
                    setTimeout(() => {
                        document.getElementById('verify-form').submit();
                    }, 500);
                }
            });
            
            // Only allow numbers
            document.getElementById('otp').addEventListener('keypress', function(e) {
                if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
                    e.preventDefault();
                }
            });
        });
    </script>
</body>

</html>