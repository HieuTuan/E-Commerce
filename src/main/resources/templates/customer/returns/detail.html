<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Yêu Cầu Hoàn Hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Timeline styles */
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-marker {
            position: absolute;
            left: -22px;
            top: 5px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            border: 2px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .timeline-content {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid #007bff;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-store me-2"></i>E-Commerce Platform
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Trang Chủ</a>
                <a class="nav-link" href="/orders">Đơn Hàng</a>
                <a class="nav-link active" href="/customer/returns">Hoàn Hàng</a>
                <form th:action="@{/logout}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-outline-light btn-sm">Đăng Xuất</button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-undo me-2"></i>Chi Tiết Yêu Cầu Hoàn Hàng</h2>
            <a href="/customer/returns" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Quay lại danh sách
            </a>
        </div>

        <div class="row">
            <div class="col-md-8">
                <!-- Return Request Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Thông Tin Yêu Cầu</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>ID Yêu cầu:</strong> <span th:text="'#' + ${returnRequest.id}">#001</span>
                                </p>
                                <p><strong>Mã trả hàng:</strong>
                                    <code th:text="${returnRequest.returnCode ?: 'Chưa có'}">RET12345678</code>
                                </p>
                                <p><strong>Trạng thái:</strong>
                                    <span th:class="${'badge ' + 
                                        (returnRequest.status.name() == 'REFUND_REQUESTED' ? 'bg-warning' :
                                         returnRequest.status.name() == 'RETURN_APPROVED' ? 'bg-success' :
                                         returnRequest.status.name() == 'REFUND_REJECTED' ? 'bg-danger' :
                                         returnRequest.status.name() == 'RETURNING' ? 'bg-info' :
                                         returnRequest.status.name() == 'RETURN_RECEIVED' ? 'bg-primary' :
                                         returnRequest.status.name() == 'REFUNDED' ? 'bg-success' : 'bg-secondary')}"
                                        th:text="${returnRequest.status?.displayName ?: 'Không xác định'}">
                                        Chờ duyệt
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Ngày tạo:</strong> <span
                                        th:text="${#temporals.format(returnRequest.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2024
                                        10:00</span></p>
                                <p><strong>Ngày cập nhật:</strong> <span
                                        th:text="${#temporals.format(returnRequest.updatedAt, 'dd/MM/yyyy HH:mm')}">01/01/2024
                                        10:00</span></p>
                                <p><strong>Lý do:</strong>
                                    <span class="badge bg-secondary"
                                        th:text="${returnRequest.reason?.displayName ?: 'Không xác định'}">Sản phẩm bị
                                        lỗi</span>
                                </p>
                            </div>
                        </div>

                        <div class="mt-3">
                            <strong>Mô tả chi tiết:</strong>
                            <p class="mt-2 p-3 bg-light rounded" th:text="${returnRequest.detailedDescription}">
                                Sản phẩm bị lỗi, không hoạt động đúng như mô tả...
                            </p>
                        </div>

                        <!-- Rejection Reason (if rejected) -->
                        <div th:if="${returnRequest.status.name() == 'REFUND_REJECTED' and returnRequest.rejectionReason != null}"
                            class="mt-3">
                            <strong>Lý do từ chối:</strong>
                            <div class="alert alert-danger mt-2" th:utext="${returnRequest.rejectionReason}">
                                Sản phẩm không đủ điều kiện hoàn trả
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Thông Tin Đơn Hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Mã đơn hàng:</strong> <span
                                        th:text="${returnRequest.order.orderNumber}">ORD001</span></p>
                                <p><strong>Tổng tiền:</strong> <span
                                        th:text="${#numbers.formatCurrency(returnRequest.order.totalAmount)}">500,000
                                        VND</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Ngày đặt:</strong> <span
                                        th:text="${#temporals.format(returnRequest.order.createdDate, 'dd/MM/yyyy HH:mm')}">01/01/2024
                                        10:00</span></p>
                                <p><strong>Trạng thái đơn hàng:</strong>
                                    <span class="badge bg-info" th:text="${returnRequest.order.status}">DELIVERED</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GHN Shipping Information -->
                <div th:if="${returnRequest.ghnOrderCode}" class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-shipping-fast me-2"></i>Thông Tin Vận Chuyển</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Mã vận đơn:</strong> <code th:text="${returnRequest.ghnOrderCode}">GHN123456</code>
                        </p>
                        <p th:if="${returnRequest.ghnTrackingNumber}">
                            <strong>Mã tracking:</strong> <code
                                th:text="${returnRequest.ghnTrackingNumber}">TRK123456</code>
                        </p>
                        <p th:if="${returnRequest.ghnFee}">
                            <strong>Phí vận chuyển:</strong>
                            <span th:text="${#numbers.formatCurrency(returnRequest.ghnFee)}"
                                class="badge bg-info">25,000 VND</span>
                        </p>
                        <div class="mt-3">
                            <a th:href="'https://tracking.ghn.dev/?order_code=' + ${returnRequest.ghnOrderCode}"
                                target="_blank" class="btn btn-primary btn-sm">
                                <i class="fas fa-external-link-alt me-2"></i>Theo dõi vận chuyển
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Return Request History -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Lịch Sử Xử Lý</h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${history != null and !history.empty}">
                            <div class="timeline">
                                <div th:each="item : ${history}" class="timeline-item">
                                    <div class="timeline-marker">
                                        <i
                                            th:class="${'fas ' + 
                                            (item.actionType == 'APPROVE' ? 'fa-check text-success' :
                                             item.actionType == 'REJECT' ? 'fa-times text-danger' :
                                             item.actionType == 'SHIP' ? 'fa-shipping-fast text-info' :
                                             item.actionType == 'RECEIVE' ? 'fa-box text-primary' :
                                             item.actionType == 'REFUND' ? 'fa-money-bill-wave text-success' : 'fa-info-circle text-secondary')}"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1" th:text="${item.actionType == 'APPROVE' ? 'Yêu cầu được duyệt' :
                                                    item.actionType == 'REJECT' ? 'Yêu cầu bị từ chối' :
                                                    item.actionType == 'SHIP' ? 'Đang vận chuyển' :
                                                    item.actionType == 'RECEIVE' ? 'Đã nhận hàng' :
                                                    item.actionType == 'REFUND' ? 'Đã hoàn tiền' : 'Cập nhật'}">Duyệt
                                                    yêu cầu</h6>
                                                <p class="mb-1 text-muted" th:utext="${item.notes}">Yêu cầu hoàn hàng đã
                                                    được duyệt</p>
                                                <div th:if="${item.ghnOrderCode}">
                                                    <small class="text-info">
                                                        <i class="fas fa-shipping-fast me-1"></i>
                                                        Mã vận đơn: <code
                                                            th:text="${item.ghnOrderCode}">GHN123456</code>
                                                    </small>
                                                </div>
                                                <div th:if="${item.ghnFee}">
                                                    <small class="text-info">
                                                        <i class="fas fa-money-bill me-1"></i>
                                                        Phí vận chuyển: <span
                                                            th:text="${#numbers.formatCurrency(item.ghnFee)}">25,000
                                                            VND</span>
                                                    </small>
                                                </div>
                                            </div>
                                            <small class="text-muted"
                                                th:text="${#temporals.format(item.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2024
                                                10:00</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div th:unless="${history != null and !history.empty}">
                            <p class="text-muted mb-0">Chưa có lịch sử xử lý</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- Status Guide -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Hướng Dẫn</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <small>
                                <strong>Trạng thái hiện tại:</strong><br>
                                <span th:switch="${returnRequest.status.name()}">
                                    <span th:case="'REFUND_REQUESTED'">
                                        <i class="fas fa-clock me-1"></i>
                                        Yêu cầu của bạn đang được xem xét. Chúng tôi sẽ phản hồi trong vòng 24 giờ.
                                    </span>
                                    <span th:case="'RETURN_APPROVED'">
                                        <i class="fas fa-check me-1"></i>
                                        Yêu cầu đã được duyệt! Vui lòng gửi hàng theo thông tin vận chuyển được cung
                                        cấp.
                                    </span>
                                    <span th:case="'REFUND_REJECTED'">
                                        <i class="fas fa-times me-1"></i>
                                        Yêu cầu hoàn hàng không được chấp nhận. Xem lý do từ chối ở trên.
                                    </span>
                                    <span th:case="'RETURNING'">
                                        <i class="fas fa-shipping-fast me-1"></i>
                                        Hàng đang được vận chuyển về kho. Bạn có thể theo dõi qua mã vận đơn.
                                    </span>
                                    <span th:case="'RETURN_RECEIVED'">
                                        <i class="fas fa-box me-1"></i>
                                        Chúng tôi đã nhận được hàng hoàn trả. Đang xử lý hoàn tiền.
                                    </span>
                                    <span th:case="'REFUNDED'">
                                        <i class="fas fa-money-bill-wave me-1"></i>
                                        Hoàn tiền thành công! Tiền sẽ được chuyển vào tài khoản của bạn trong 3-5 ngày
                                        làm việc.
                                    </span>
                                    <span th:case="*">Trạng thái không xác định</span>
                                </span>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Bank Information -->
                <div th:if="${returnRequest.bankInfo}" class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-university me-2"></i>Thông Tin Hoàn Tiền</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Ngân hàng:</strong> <span
                                th:text="${returnRequest.bankInfo.bankName}">Vietcombank</span></p>
                        <p><strong>Số tài khoản:</strong> <code
                                th:text="${returnRequest.bankInfo.accountNumber}">1234567890</code></p>
                        <p><strong>Chủ tài khoản:</strong> <span
                                th:text="${returnRequest.bankInfo.accountHolderName}">NGUYEN VAN A</span></p>
                    </div>
                </div>

                <!-- Refund Proof (if refunded) -->
                <div th:if="${returnRequest.status.name() == 'REFUNDED' and returnRequest.refundProofImageUrl != null}"
                    class="card mb-4 border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Chứng Từ Hoàn Tiền</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Giao dịch hoàn tiền thành công!</strong><br>
                            <small>Dưới đây là chứng từ chuyển khoản từ cửa hàng. Tiền sẽ được chuyển vào tài khoản của
                                bạn trong 3-5 ngày làm việc.</small>
                        </div>
                        <div class="text-center">
                            <img th:src="${returnRequest.refundProofImageUrl}" alt="Chứng từ hoàn tiền"
                                class="img-fluid rounded border shadow"
                                style="max-width: 300px; max-height: 300px; object-fit: contain; cursor: pointer;"
                                onclick="window.open(this.src, '_blank')">
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>Click vào ảnh để xem kích thước đầy đủ
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Evidence Video -->
                <div th:if="${returnRequest.evidenceVideoUrl}" class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-video me-2"></i>Video Bằng Chứng</h5>
                    </div>
                    <div class="card-body">
                        <video controls class="w-100" style="max-height: 200px;">
                            <source th:src="${returnRequest.evidenceVideoUrl}" type="video/mp4">
                            Trình duyệt của bạn không hỗ trợ video HTML5.
                        </video>
                        <a th:href="${returnRequest.evidenceVideoUrl}" target="_blank"
                            class="btn btn-outline-primary btn-sm mt-2">
                            <i class="fas fa-external-link-alt me-2"></i>Mở trong tab mới
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>